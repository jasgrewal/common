---
title: "Modifying ggplot objects - intermediate tutorial"
author: Jasleen Grewal
header-includes: \usepackage{color}
output: 
  html_document: 
    latex_engine: xelatex
    toc: true
    toc_depth: 3
---

```{r, echo=FALSE, eval=TRUE}
library(knitr)
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE, tidy.opts=list(width.cutoff=90),tidy=TRUE)
height_basic=6
```


# Getting started 
If this is your first time using the ggplot2 library within R, please refer to the [**Beginners Tutorial**]().  

```{r opts, eval=FALSE}
install.packages("ggplot2")
```

Let us load up ggplot2 into our current environment.  
```{r, eval=TRUE}
require(ggplot2)
```

## Get Data  
We will be working with one of the example datasets available within the ggplot2 library, called msleep. This dataset contains statistics on sleep patterns for certain mammals.  
```{r, eval=TRUE}
data("msleep", package = "ggplot2")
```

We can take a peek at the data, using the `head` command.  
```{r, eval=TRUE} 
kable(head(msleep))
```

\pagebreak  

## ggplot - Review

Let us take a quick look at the plot script for the last ggplot figure we generated in the preceding tutorial.   
```{r, eval=TRUE, echo=TRUE, fig.width=6, fig.height=5.5}
ggplot(msleep, aes(x=vore, y=sleep_rem)) + geom_point(alpha=0.5) + stat_summary() + theme_minimal()   + theme(text = element_text(size=12)) + ggtitle("I changed the title") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1)) + labs(x="-vore", y="REM sleep") + facet_wrap(~conservation, ncol=2)
```

There are 5 key points in this long line of code:   

  - The **data** object is *msleep*.    
  - We used *theme_minimal()* to apply a clean background (not grey!) to our plot.    
  - We modified the text size and plot title placement using *theme()*.  
  - We use *theme_minimal* **before** we add any modifications to *theme()*, because otherwise *theme_minimal()* will reset any changes we added to our figure using *theme()*.   
  - We separated different categories (in 'conservation') using *facet_wrap()*, and fixed the maximum number of 'columns' we wanted the facets to take up as **2**.   

Here's a quick way to shorten this code even further. We can combine the **font** attributes we defined in *theme()* within our complete ggplot theme, *theme_minimal()*. Check to see if this gives the same figure as above.  

```{r, eval=FALSE, echo=TRUE, fig.width=6, fig.height=5}
ggplot(msleep, aes(x=vore, y=sleep_rem)) + geom_point(alpha=0.5) + stat_summary() + theme_minimal(base_size=12)  + ggtitle("I changed the title") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1)) + labs(x="-vore", y="REM sleep") + facet_wrap(~conservation, ncol=2)
```
  - *hjust=0.5* means align text at the center, whereas *hjust=1* means right, and *hjust=0* means left.  

\pagebreak  

# Modifying ggplot outputs  
Before we dive into visualizing this data in different ways, let me touch upon an error message you may receive as you run the code above,  
Warning message: <span style="color:red">Removed 22 rows containing missing values (geom_point)</span>.  
This is because we have 'NA' values in our dataframe. We can overcome this by updating our msleep to get rid of rows that contain 'NA'. This is done using the function **na_omit()**.  

```{r, eval=TRUE, echo=TRUE}
msleep = na.omit(msleep)
```

## Adjust panel layouts   

The *facet_wrap()* function lets us split our data-points into separate groups based on a single column. We can also do this to compare two columns. If we are interested in visualizing all pair-wise comparisons between two columns (even when there may be no data points available for certain pairs of values), we use *facet_grid()*. 
The following two plots show the difference between the outputs based in which of these we use. Since most of our ggplot will retain the same structure, I will 'save' it as a separate object first. This is useful if we want to keep adding new 'geometric objects' on top of our original ggplot figure, without copying the code every single time.  

```{r, eval=TRUE, echo=TRUE, fig.width=6, fig.height=5}
g1_main <- ggplot(msleep, aes(x=vore, y=sleep_rem)) + geom_point(alpha=0.5) + stat_summary() + theme_minimal(base_size=11) + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 45, hjust = 1)) + labs(x="-vore", y="REM sleep")

## Create Facet Wrap plot
g1_fw <- g1_main + ggtitle("Facet Wrap plot between -vore status and conservation") + facet_wrap(vore~conservation)
## Print this  
g1_fw

## Create Facet Grid plot
g1_fg <- g1_main + ggtitle("Facet Wrap plot between -vore status and conservation") + facet_grid(vore~conservation)
## Print this
g1_fg
```

As you can see, the facet_grid() is much more readable. We can improve readibility by removing entries along the x-axis that do not have any values in a given 'panel'. This is done using the **scales** option in *facet_grid()* - the possible values are "free_x", "free_y", "free". Depending on what you want your reader to focus on, one of these options may be chosen.  
We can also make sure the panel width is complementary to the amount of space the data points *actually* take up. We can set this using the **space** option, which has the same set of possible values as **scales**.  

```{r, eval=TRUE, echo=TRUE, fig.width=6, fig.height=5}
# Create plot object
g1_fg_clean <- g1_main + ggtitle("Compact Facet Wrap plot between -vore status and conservation") + facet_grid(vore~conservation, scales = "free_x", space="free_x")
# Print plot object
g1_fg_clean
```
  - Try removing the 'space' option and see how the plot changes.  
  - What happens if you set scales = "free"? Do you see why including a free scale for 'y' might be misleading for readers?  
  - Do you also see how it is handy to create a new plot object?  

## Highlighting a part of the plot  
Sometimes we may want to draw attention to only specific entries in the plot. For example, in the plot above, looking at the spread of REM sleep for pairwise combinations of '-vore' and 'conservation', we might want to particularly focus on domesticated herbivores (vore=="herbi", conservation=="domesticated"). We can explicitly plot these points on top of our existing figure, as shown below:  

```{r, eval=TRUE, echo=TRUE, fig.width=6, fig.height=5}
g1_fg + geom_point(data=msleep[msleep$vore=="herbi" & msleep$conservation=="domesticated", ], colour="red")
```

What did we do here? We took our pre-existing plot where everything had been plotted. We then specified only a *part* of our original dataset to be passed to a new geometric function, a *geom_point()*, and we set the colour="red" for all the points that this geom_point() is plotting.   

TODO: We can also go the other way, where we add **all** the points to **all** the panels as **background**. For this, however, we will have to go back to our original plot snippet and place the new 'geom_point' object at the *right* order (i.e. before we induce separation of points by facet)    
```{r, eval=TRUE, echo=TRUE, fig.width=6, fig.height=5}
g1_main + ggtitle("Compact Facet Wrap plot between -vore status and conservation") + geom_point(data=msleep[msleep$vore=="herbi" & msleep$conservation=="domesticated", ], colour="red")

```
